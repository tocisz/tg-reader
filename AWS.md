# Deploying tg-reader to AWS Lambda for Daily Telegram Group Summaries

This guide explains how to deploy the `tg-reader` project to AWS so it checks all your Telegram groups every day (e.g., at 4 a.m.), summarizes them, and sends results via email using Amazon SES.

## Prerequisites
- AWS CLI installed and configured (`aws configure`)
- Python 3.12 compatible code and dependencies
- jq, zip, and bash available
- Your Telegram and Gemini API credentials in `config.json`
- Your SES sender email address (must be verified)

## Steps

### 1. Prepare the Project
- Ensure your project directory contains all code, including `scheduled_tg.py`, `aws_provider.py`, and dependencies.
- Set your Telegram and Gemini credentials in `config.json`.
- Edit `scheduled.json`:
  - Set `group_name` to `all` to process all groups.
  - Set `summarize` to `true` if you want summaries.
  - Set your email address in `email_address`.
  - Under `provider`, set `type` to `aws` and fill in your S3 bucket and SES sender (these can be generated by the deploy script):

```json
"provider": {
  "type": "aws",
  "aws": {
    "s3_bucket": "your-s3-bucket-name",
    "ses_sender": "verified-sender@email.com",
    "ses_region": "us-east-1"
  }
}
```

### 2. Deploy to AWS

Run the deployment script:

```bash
bash deploy_aws.sh install
```

This will:
- Create a new S3 bucket for state and results
- Create an IAM role for Lambda with S3, SES, and logging permissions
- Verify your SES sender email (you must confirm the link in your inbox)
- Package your code and deploy it as a Lambda function
- Set Lambda environment variables
- Schedule the Lambda to run daily at 4 a.m. (see below)

### 3. Schedule Lambda for 4 a.m. Daily

By default, the script uses `cron(0 4 * * ? *)`. To change it edit the schedule expression in `deploy_aws.sh`, e.g.:

```
SCHEDULE="rate(1 day)"
```

This will trigger the Lambda daily. Adjust for your timezone as needed.

### 4. Confirm SES Email Verification
- Check your inbox for a verification email from AWS SES.
- Click the verification link before continuing.

### 5. Monitor and Test
- Check the AWS Lambda console for logs and invocations.
- Check your S3 bucket for uploaded files.
- Check your email for daily summaries.

### 6. Security and Cleanup
- The Lambda role is granted S3, SES, and logging permissions only.
- To remove resources, delete the Lambda, S3 bucket, EventBridge rule, and IAM role via the AWS Console or CLI.

## Troubleshooting
- If emails are not received, ensure SES is out of sandbox mode or all recipients are verified.
- Check Lambda logs in CloudWatch for errors.
- Ensure all environment variables and config files are present in the Lambda package.

---

For further customization (e.g., custom schedule, more recipients, or different regions), edit `deploy_aws.sh` and `scheduled.json` accordingly.
